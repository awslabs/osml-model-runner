default:
  tags:
    - dind

stages:
  - build
  - sast
  - dast
  - test 
  - publish 

include:
  - template: Security/SAST.gitlab-ci.yml
  - project: 'DevOps/security-scanning/scanning-templates'
    file: '/sonarqube-check.yml'
  - project: 'DevOps/security-scanning/scanning-templates'
    file: '/owasp-depcheck.yml'
  - project: 'DSO-Millennium-Falcon/gitlab-ci-templates/scanning-templates'
    ref: grype
    file: '/Container-Scanning.gitlab-ci.yml' 


variables: 
  BUILD_CERT: /certs/tls-ca-bundle.pem
  PIP_INSTALL_LOCATION: https://mirrors.gs.mil/repository/pypi.org-proxy/simple

create_runner:
  stage: build
  tags:
    - dind
  before_script:
    # Login to iron bank per instructions here: https://discourse.gs.mil/t/how-do-i-use-platform-one-iron-bank-hosted-images-at-nga/5187/2
    - docker login -u ${REGISTERY1_USERNAME} -p ${REGISTERY1_PASSWORD} registry1.dso.mil 
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - mkdir -p certs/ && cp /certs/tls-ca-bundle.pem certs/tls-ca-bundle.pem
    - | 
      docker build --target cert-base \
                    -f docker/Dockerfile.mr_container \
                    -t ${CI_REGISTRY_IMAGE}/cert-base:${CI_COMMIT_REF_SLUG} .
    - docker push ${CI_REGISTRY_IMAGE}/cert-base:${CI_COMMIT_REF_SLUG}
    - |
      docker build --target runner \
                    -f docker/Dockerfile.mr_container \
                    --build-arg PIP_INSTALL_LOCATION=$PIP_INSTALL_LOCATION \
                    --build-arg BUILD_CERT=$BUILD_CERT \
                    --build-arg BASE_CONTAINER=${CI_REGISTRY_IMAGE}/cert-base:${CI_COMMIT_REF_SLUG} \
                    -t ${CI_REGISTRY_IMAGE}/aip-mr-runner:${CI_COMMIT_REF_SLUG} .
    - docker push ${CI_REGISTRY_IMAGE}/aip-mr-runner:${CI_COMMIT_REF_SLUG}


# TODO: Stage should be added back in when we figure out how we can use
#  it to accelerate builds on downstream stages, currently stages always do a full rebuild 
# create_gdal_base:
#   # This stage exists for posterity and so we can audit our gdal base build easily, 
#   #   allowing devs to quickly pull a complex changed gdal for debugging
#   stage: build
#   tags:
#     - dind
#   before_script:
#     # Login to iron bank per instructions here: https://discourse.gs.mil/t/how-do-i-use-platform-one-iron-bank-hosted-images-at-nga/5187/2
#     - docker login -u ${REGISTERY1_USERNAME} -p ${REGISTERY1_PASSWORD} registry1.dso.mil 
#     - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
#   script:
#     - mkdir -p certs/ && cp /certs/tls-ca-bundle.pem certs/tls-ca-bundle.pem
#     - | 
#       docker build --target gdal-base \
#                     -f docker/Dockerfile.mr_container \
#                     -t ${CI_REGISTRY_IMAGE}/gdal-base:${CI_COMMIT_REF_SLUG} .
#     - docker push ${CI_REGISTRY_IMAGE}/gdal-base:${CI_COMMIT_REF_SLUG}


fortify_build:
  stage: sast
  image: gitlab-registry.gs.mil/chargeback/docker/fortify-sca-py38:latest
  tags:
    - standard
  variables: 
    CLASSPATH: "/usr/share/java/*.jar"
    JOB_NAME: "python_scan"
    APP_NAME: 'AIP-Model-Runner'    
    HP_FORTIFY_SCAN_FILE_NAME: "fortifyResults-${CI_COMMIT_SHA}.fpr"
    HP_FORTIFY_REPORT_FILE_NAME: "fortifyResults-${CI_COMMIT_SHA}.pdf"
    SECURITY_SCANS_FOLDER: 'security-scans'
    WORKSPACE: "."
  script:
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} -clean
    - mkdir $WORKSPACE/${SECURITY_SCANS_FOLDER}
    #- pip3 install -r ./requirements.txt --user
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} "src/**/*.py"  -python-version 3 -python-path `python3 -c "import sys;sys.path.append(r'~/.local/');print(':'.join(sys.path))"` -Dcom.fortify.sca.follow.imports=false        
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} -show-files
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} -scan -f "$WORKSPACE/${SECURITY_SCANS_FOLDER}/${HP_FORTIFY_SCAN_FILE_NAME}"
    - /opt/Fortify/bin/ReportGenerator -format pdf -f "$WORKSPACE/${SECURITY_SCANS_FOLDER}/${HP_FORTIFY_REPORT_FILE_NAME}" -source "$WORKSPACE/${SECURITY_SCANS_FOLDER}/${HP_FORTIFY_SCAN_FILE_NAME}" -showSuppressed -showHidden
  artifacts:
    paths:
      - security-scans/


bandit-sast: 
  stage: sast 


semgrep-sast: 
  stage: sast 


sonarqube_scanning: 
  stage: sast 

# Serves to perform grype scans until inherieted pipeline resolves permanent false loop 
grype_scanner:
  stage: dast
  before_script: 
    - WORK_DIR="$PWD"
    - cd /etc/pki/ca-trust/source/anchors
    - awk 'BEGIN {c=0;} /BEGIN CERT/{c++} { print > "cert." c ".pem"}' < /certs/tls-ca-bundle.pem
    - cd "$WORK_DIR"
  image:
    name: $CI_REGISTRY/dso-millennium-falcon/docker/grype:4-fips
  variables:
    DOCKER_CERT_PATH: /etc/pki/ca-trust/source/anchors
    CONTAINER_SCANNING_DISABLED: "true"
    CS_ANALYZER_IMAGE: $CI_REGISTRY/dso-millennium-falcon/docker/grype:4-fips
    ADDITIONAL_CA_CERT_BUNDLE: /certs/tls-ca-bundle.pem
    GIT_STRATEGY: none
    DOCKER_IMAGE: ${CI_REGISTRY_IMAGE}/aip-mr-runner:${CI_COMMIT_REF_SLUG}
    DOCKERFILE_PATH: docker/Dockerfile.mr_container
  allow_failure: true
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
      dependency_scanning: gl-dependency-scanning-report.json
    paths: [gl-container-scanning-report.json, gl-dependency-scanning-report.json]
  dependencies: []
  script:
    - gtcs scan


container_scanning:
  stage: dast
  variables:
    DOCKER_IMAGE: ${CI_REGISTRY_IMAGE}/aip-mr-runner:${CI_COMMIT_REF_SLUG}
    DOCKERFILE_PATH: docker/Dockerfile.mr_container


owasp_depcheck_scan:
  stage: dast
  variables:
    SUBFOLDER_TO_SCAN: ./
    dependency_files: requirements.txt
  cache:
    paths:
      - ./

pytest_functionality: 
  stage: test
  image: gitlab-registry.gs.mil/maven-integration/aws/aws-aip/aip-model-runner/aip-mr-runner:${CI_COMMIT_REF_SLUG}
  script: 
    - pip3 install --index-url $PIP_INSTALL_LOCATION --cert $BUILD_CERT -r requirements-test.txt -t .
    - python3 -m pytest --cov=aws_oversightml_model_runner test/

Export Image:
  stage: publish
  image: ${CI_REGISTRY}/devsecops_public/gitlab-runner-images/docker:devops
  services:
    - name: ${CI_REGISTRY}/devsecops_public/gitlab-runner-images/docker:devops-dind
      alias: docker
      command: ["--insecure-registry", "gitlab-registry.gs.mil"]
  script:
    - docker info
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
    - docker pull ${CI_REGISTRY_IMAGE}/${MODEL_NAME}:${MODEL_TAG}
    - docker save ${CI_REGISTRY_IMAGE}/${MODEL_NAME}:${MODEL_TAG}  > ${ARTIFACT}
    - docker logout ${CI_REGISTRY} 
    - curl --user "${NEXUS3_USER}:${NEXUS3_PASSWORD}" --upload-file ./${ARTIFACT} ${NEXUS3_REPOS}/aip/${ARTIFACT}
  tags:
    - dind
  timeout: 3h
  variables:
    MODEL_NAME: "aip-mr-runner"
    MODEL_TAG: "mainline"
    NEXUS3_REPOS: "https://nexus3.gs.mil/repository/Maven_artifacts"
    NEXUS3_USER: ${maven_integration_nexus_3_credential_username}
    NEXUS3_PASSWORD: ${maven_integration_nexus_3_credential_password}
    ARTIFACT: "${MODEL_NAME}-${MODEL_TAG}.tar"
  only:
    - mainline