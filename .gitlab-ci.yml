default:
  tags:
    - dind

stages:
  - build
  - security_scans
  - test
  - publish
  - transfer

include:
  - .gitlab/security.gitlab-ci.yml
  - project: 'maven-integration/public/cicd-examples'
    ref: main
    file: '.gitlab-ci.yml'
  # Add back in as program or security asks for sonarqube or owasp onboarding 
  # - project: 'DevOps/security-scanning/scanning-templates'
  #   file: '/sonarqube-check.yml'
  # - project: 'DevOps/security-scanning/scanning-templates'
  #   file: '/owasp-depcheck.yml'

variables: 
  BUILD_CERT: /certs/tls-ca-bundle.pem
  BASE_GIT_URL: https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.gs.mil/maven-integration/aws/aws-aip
  PIP_INSTALL_LOCATION: https://mirrors.gs.mil/repository/pypi.org-proxy/simple
  NEXUS3_USER: ${maven_integration_nexus_3_credential_username}
  NEXUS3_PASSWORD: ${maven_integration_nexus_3_credential_password}
  MODEL_NAME: "aip-mr-runner"
  MODEL_TAG: "mainline"

  MODEL_RUNNER_IMAGE: $CI_REGISTRY_IMAGE/aip-mr-runner:$CI_COMMIT_REF_SLUG

create_runner:
  stage: build
  tags:
    - dind
  before_script:
    # Login to iron bank per instructions here: https://discourse.gs.mil/t/how-do-i-use-platform-one-iron-bank-hosted-images-at-nga/5187/2
    - docker login -u ${REGISTERY1_USERNAME} -p ${REGISTERY1_PASSWORD} registry1.dso.mil
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - mkdir -p certs/ && cp /certs/tls-ca-bundle.pem certs/tls-ca-bundle.pem
    - | 
      docker build --target cert-base \
                    -f docker/Dockerfile.mr_container \
                    -t ${CI_REGISTRY_IMAGE}/cert-base:${CI_COMMIT_REF_SLUG} .
    - docker push ${CI_REGISTRY_IMAGE}/cert-base:${CI_COMMIT_REF_SLUG}
    - |
      docker build --target runner \
                    -f docker/Dockerfile.mr_container \
                    --build-arg PIP_INSTALL_LOCATION=$PIP_INSTALL_LOCATION \
                    --build-arg BUILD_CERT=$BUILD_CERT \
                    --build-arg BASE_CONTAINER=${CI_REGISTRY_IMAGE}/cert-base:${CI_COMMIT_REF_SLUG} \
                    --build-arg CI=${CI} \
                    --build-arg NEXUS_AUTH=${NEXUS3_USER}:${NEXUS3_PASSWORD} \
                    -t $MODEL_RUNNER_IMAGE .
    - docker push $MODEL_RUNNER_IMAGE


# TODO: Stage should be added back in when we figure out how we can use
#  it to accelerate builds on downstream stages, currently stages always do a full rebuild 
# create_gdal_base:
#   # This stage exists for posterity and so we can audit our gdal base build easily, 
#   #   allowing devs to quickly pull a complex changed gdal for debugging
#   stage: build
#   tags:
#     - dind
#   before_script:
#     # Login to iron bank per instructions here: https://discourse.gs.mil/t/how-do-i-use-platform-one-iron-bank-hosted-images-at-nga/5187/2
#     - docker login -u ${REGISTERY1_USERNAME} -p ${REGISTERY1_PASSWORD} registry1.dso.mil 
#     - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
#   script:
#     - mkdir -p certs/ && cp /certs/tls-ca-bundle.pem certs/tls-ca-bundle.pem
#     - | 
#       docker build --target gdal-base \
#                     -f docker/Dockerfile.mr_container \
#                     -t ${CI_REGISTRY_IMAGE}/gdal-base:${CI_COMMIT_REF_SLUG} .
#     - docker push ${CI_REGISTRY_IMAGE}/gdal-base:${CI_COMMIT_REF_SLUG}


fortify_build:
  stage: security_scans
  image: gitlab-registry.gs.mil/chargeback/docker/fortify-sca-py38:latest
  tags:
    - standard
  variables: 
    CLASSPATH: "/usr/share/java/*.jar"
    JOB_NAME: "python_scan"
    APP_NAME: 'AIP-Model-Runner'    
    HP_FORTIFY_SCAN_FILE_NAME: "fortifyResults-${CI_COMMIT_SHA}.fpr"
    HP_FORTIFY_REPORT_FILE_NAME: "fortifyResults-${CI_COMMIT_SHA}.pdf"
    SECURITY_SCANS_FOLDER: 'security-scans'
    WORKSPACE: "."
  script:
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} -clean
    - mkdir $WORKSPACE/${SECURITY_SCANS_FOLDER}
    #- pip3 install -r ./requirements.txt --user
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} "src/**/*.py"  -python-version 3 -python-path `python3 -c "import sys;sys.path.append(r'~/.local/');print(':'.join(sys.path))"` -Dcom.fortify.sca.follow.imports=false        
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} -show-files
    - /opt/Fortify/bin/sourceanalyzer -64 -verbose -Xms2G -Xmx10G -b ${JOB_NAME} -scan -f "$WORKSPACE/${SECURITY_SCANS_FOLDER}/${HP_FORTIFY_SCAN_FILE_NAME}"
    - /opt/Fortify/bin/ReportGenerator -format pdf -f "$WORKSPACE/${SECURITY_SCANS_FOLDER}/${HP_FORTIFY_REPORT_FILE_NAME}" -source "$WORKSPACE/${SECURITY_SCANS_FOLDER}/${HP_FORTIFY_SCAN_FILE_NAME}" -showSuppressed -showHidden
  artifacts:
    paths:
      - security-scans/

# Add back in as program or security asks for sonarqube or owasp onboarding 
# sonarqube_scanning: 
#   stage: security_scans 


pytest_functionality: 
  stage: test
  image: ${CI_REGISTRY_IMAGE}/aip-mr-runner:${CI_COMMIT_REF_SLUG}
  script: 
    - pip3 install --index-url $PIP_INSTALL_LOCATION --cert $BUILD_CERT -r test/requirements-test.txt -t .
    - python3 -m pytest --cov=aws_oversightml_model_runner test/

publish:
  stage: publish
  tags:
    - dind
  only:
    - main
  variables:
    NEXUS3_REPOS: "https://nexus3.gs.mil/repository/Maven_artifacts"
    ARTIFACT: "${MODEL_NAME}-${MODEL_TAG}-${CI_COMMIT_REF_SLUG}.tar.gz"
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker pull $MODEL_RUNNER_IMAGE
    - docker save $MODEL_RUNNER_IMAGE | gzip > ${ARTIFACT}
    - curl --user "${NEXUS3_USER}:${NEXUS3_PASSWORD}" --upload-file ./${ARTIFACT} ${NEXUS3_REPOS}/aip/${ARTIFACT}

export_unavailable: 
  stage: publish 

export-image-diode: 
  stage: publish
