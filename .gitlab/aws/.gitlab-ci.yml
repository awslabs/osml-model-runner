---
# AWS GitLab Model Runner Entrypoint 
#

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"  # Allow manual pipeline execution
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG

stages:
  - identify_tag_version
  - lint
  - prepare
  - build
  - unit
  - test
  - security
  - docs
  - deploy
  - cleanup
  - push
  - release

before_script:
  - |
    if [ -z "${CURRENT_TAG}" ]; then
      export CURRENT_TAG_VERSION=$(grep -m1 '"version":' version.json | tr -d '[:space:]' | cut -d':' -f2 | tr -d ',"')
      export CURRENT_TAG="v$(echo ${CURRENT_TAG_VERSION} | tr '.' '-')"
      echo "CURRENT_TAG=$CURRENT_TAG" > vars.env
    fi
  - echo "Using CURRENT_TAG=$CURRENT_TAG"

variables:
  GITLAB_ANALYZER_SEVERITY: high  # tuned for customer requirements
  # PROJECT_ROOT will be set as a group variable in GitLab CI/CD settings
  NEXUS_URL: ${NEXUS_URL}  # GitLab group CI variable
  GDAL_BASE_IMG: ${CI_REGISTRY}/${PROJECT_ROOT}/common/gdal-base:v3-8-5-2
  MICROSERVICE: "ie-model-runner"
  MICROSERVICE_IMAGE: ${CI_REGISTRY_IMAGE}/${MICROSERVICE}:${CI_COMMIT_REF_SLUG}
  DOCKERFILE: docker/Dockerfile

include:
  # Common templates from project (uses default branch: mainline)
  - project: '${PROJECT_ROOT}/common/cicd-templates'
    file: 'templates.gitlab-ci.yml'

  # AWS-specific templates (uses default branch: mainline)
  - project: '${PROJECT_ROOT}/common/cicd-templates'
    file: 'templates-aws.gitlab-ci.yml'

  # Environment-specific templates (uses default branch: mainline)
  - project: '${PROJECT_ROOT}/common/cicd-templates'
    file: 'templates-environment.gitlab-ci.yml'

  # Always included jobs
  - local: .gitlab/aws/always/*.gitlab-ci.yml

  # Merge request specific jobs
  - local: .gitlab/aws/merge_request/*.gitlab-ci.yml
    rules:
      - if: $CI_PIPELINE_SOURCE == "merge_request_event"

  # Tag/release specific jobs
  - local: .gitlab/aws/tag/*.gitlab-ci.yml
    rules:
      - if: $CI_COMMIT_TAG

  # Overrides
  - local: .gitlab/aws/.overrides.gitlab-ci.yml

# Version identification
identify_tag_version:
  extends: .identify_tag_version_template

release:
  extends: .release_template
  rules:
    - if: $CI_COMMIT_TAG

push_to_cwe:
  extends: .push_template
