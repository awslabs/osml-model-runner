# This workflow will upload a Python Package using Twine when a release is created
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#publishing-to-package-registries

name: Publish to PyPI

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.13'

jobs:
  publish-package:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: release
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python_version: ${{ env.PYTHON_VERSION }}
          cache_dependency_paths: 'pyproject.toml,setup.py'
      - name: Build Package
        run: |
          pip install build
          python -m build
      - name: Validate package version
        run: |
          VERSION=$(python -c "import json; print(json.load(open('pyproject.toml'))['project']['version'])" 2>/dev/null || python -c "import setuptools; setuptools.setup()" --version 2>/dev/null || echo "")
          if [ -z "$VERSION" ]; then
            echo "Error: Could not determine package version"
            exit 1
          fi
          echo "Building version: $VERSION"
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
